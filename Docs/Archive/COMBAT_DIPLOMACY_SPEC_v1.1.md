# СПЕЦИФИКАЦИЯ БОЕВОЙ И ДИПЛОМАТИЧЕСКОЙ СИСТЕМЫ v1.1

**Проект:** Сумрачные Пределы (Twilight Marches)
**Модуль:** Унифицированная система встреч
**Статус:** Утверждено к разработке
**Дата:** 1 февраля 2026

**Заменяет:** Раздел 9 в `GAME_DESIGN_DOCUMENT.md` (полная замена механик d6 на Колоду Судьбы)
**Зависимости:** `PROJECT_BIBLE.md` (Столпы), `ENGINE_ARCHITECTURE.md`, `EXPLORATION_CORE_DESIGN.md`

---

## Оглавление

1. [Философия: Унифицированные встречи](#1-философия-унифицированные-встречи)
2. [Структура раунда (Игровой цикл)](#2-структура-раунда-игровой-цикл)
3. [Математика: Система проверок Судьбы](#3-математика-система-проверок-судьбы)
4. [Влияние Резонанса](#4-влияние-резонанса)
5. [Переходы: Бой ↔ Дипломатия](#5-переходы-бой--дипломатия)
6. [Структуры данных](#6-структуры-данных)
7. [Требования к UI/UX](#7-требования-к-uiux)
8. [Задачи реализации](#8-задачи-реализации)
9. [Примеры и сценарии](#9-примеры-и-сценарии)

---

## Обзор системы

```
┌─────────────────────────────────────────────────────────────────┐
│                      СИСТЕМА ВСТРЕЧ                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     ПРОТИВНИК                           │   │
│  │  ┌─────────────┐        ┌─────────────┐                 │   │
│  │  │ 🔴 ТЕЛО     │        │ 🔵 ДУХ      │                 │   │
│  │  │    (HP)     │        │    (WP)     │                 │   │
│  │  │             │        │             │                 │   │
│  │  │ Путь: Убить │        │ Путь: Уми-  │                 │   │
│  │  │ Инстр: Атака│        │ ротворить   │                 │   │
│  │  │ Награда:    │        │ Инстр:      │                 │   │
│  │  │  Предметы   │        │  Влияние    │                 │   │
│  │  │ Резонанс:   │        │ Награда:    │                 │   │
│  │  │  → Навь     │        │  Инфо/Карты │                 │   │
│  │  └─────────────┘        │ Резонанс:   │                 │   │
│  │                         │  → Правь    │                 │   │
│  │                         └─────────────┘                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   КОЛОДА СУДЬБЫ                         │   │
│  │  Универсальная для всех контекстов                      │   │
│  │  Карта = value + suit + keyword + intensity             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      РЕЗОНАНС                           │   │
│  │  ☽ Навь ◄━━━━━━━━●━━━━━━━━► Правь ☀                    │   │
│  │   -100         Явь (0)           +100                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 1. Философия: Унифицированные встречи

Мы отказываемся от разделения игры на "режим боя" и "режим диалога". Любая встреча с сущностью (Монстр, NPC, Дух) — это **Встреча** с двумя шкалами прогресса.

### 1.1 Ключевые принципы

| Принцип | Описание |
|---------|----------|
| **Двойная шкала** | У каждого врага две "полоски здоровья": Тело (HP) и Дух (WP/Воля) |
| **Активная защита** | Враги никогда не бросают кости/карты. Урон врага статичен (Намерение). Игрок проходит проверку для защиты |
| **Колода Судьбы** | Карты заменяют кости. Значение карты всегда добавляется к статам игрока (Больше = Лучше) |
| **Физика Резонанса** | Состояние мира (Навь/Правь) физически влияет на эффективность карт |

### 1.2 Система двойной шкалы

У каждого противника два параметра:

```
┌─────────────────────────────────────────────────────────┐
│  🔴 ТЕЛО (HP) — Физическая форма                        │
│  ─────────────────────────────────────                  │
│  Инструмент: Физические атаки                           │
│  Победа (Убить): Враг умирает                           │
│  Добыча: Материальные предметы                          │
│  Резонанс: Сдвигается к НАВИ (тьма)                    │
├─────────────────────────────────────────────────────────┤
│  🔵 ДУХ (WP) — Сила воли / Решимость                   │
│  ─────────────────────────────────────                  │
│  Инструмент: Духовное/Социальное влияние               │
│  Победа (Умиротворить): Враг сдаётся, сбегает, очищен  │
│  Добыча: Информация, особые карты                       │
│  Резонанс: Сдвигается к ПРАВИ (свет)                   │
└─────────────────────────────────────────────────────────┘
```

### 1.3 Приоритет определения победы

```
                      ИСХОД ВСТРЕЧИ
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
     HP ≤ 0?          WP ≤ 0?          Сбежал?
          │                │                │
          ▼                ▼                ▼
   ╔═══════════╗   ╔═══════════╗   ╔═══════════╗
   ║   УБИТ    ║   ║ УМИРОТВО- ║   ║  СБЕЖАЛ   ║
   ║           ║   ║   РЁН     ║   ║           ║
   ╠═══════════╣   ╠═══════════╣   ╠═══════════╣
   ║ → Навь    ║   ║ → Правь   ║   ║ Без смены ║
   ║ Предметы  ║   ║ Инфо/Карты║   ║ резонанса ║
   ╚═══════════╝   ╚═══════════╝   ╚═══════════╝

   ⚠️ ПРАВИЛО: HP=0 имеет приоритет над WP=0
      (Мёртвый враг не может сдаться)
```

**Приоритет разрешения победы:**
- Если `HP <= 0`: Враг **УБИТ** (независимо от состояния WP)
- Если `WP <= 0` (и HP > 0): Враг **УМИРОТВОРЁН**
- *Обоснование:* Мёртвый враг не может сдаться. Это создаёт skill expression для "дипломатов", которые должны контролировать свой урон.

> **Требование дизайна (жизнеспособность умиротворения):** Для viability пути Умиротворения в картах/эффектах должны существовать инструменты контроля урона по HP: Оглушение, Разоружение, "Spirit-only" финишные действия, эффекты снижения физического урона. Без этих инструментов путь дипломатии будет frustrating.

> **Встречи с несколькими врагами:** В встрече с несколькими врагами исход фиксируется **per-entity**. Итог встречи определяется сценарием:
> - Если убит хоть один враг — ставится флаг `violence: true`
> - Если все враги умиротворены — флаг `nonviolent: true`
> - Смешанный исход (часть убита, часть умиротворена) допустим; сценарий определяет последствия
>
> **Завершение встречи:** Встреча завершается, когда все враги либо убиты, либо умиротворены, либо сбежали. Смешанный исход влияет на последствия, но не мешает завершению.

### 1.4 Принцип активной защиты

Враг **никогда не бросает кости и не тянет карты**. Враг — это **генератор проблем**.

```
┌──────────────────────┐         ┌──────────────────────┐
│        ВРАГ          │         │       ИГРОК          │
│  Создаёт статичную   │  ───▶   │  Должен найти ответ  │
│  угрозу (Намерение)  │         │  (Карты + Проверка)  │
│  "Нанесёт 10 урона"  │         │  "Блок + Судьба +2"  │
└──────────────────────┘         └──────────────────────┘
```

---

## 2. Структура раунда (Игровой цикл)

Бой делится на **3 фазы** за раунд.

### Диаграмма игрового цикла

```
┌─────────────────────────────────────────────────────────────────┐
│                      НАЧАЛО РАУНДА                              │
└─────────────────────────┬───────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│  ФАЗА 0: НАМЕРЕНИЕ ВРАГА                                        │
│  ─────────────────────────                                      │
│  Враг показывает, что собирается делать:                        │
│  ⚔️ Атака 8  │  🛡️ Защита  │  💀 Ритуал  │  🔥 Подготовка     │
└─────────────────────────┬───────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│  ФАЗА 1: ХОД ИГРОКА                                             │
│  ─────────────────────                                          │
│  1. Разыгрывать карты (Бафф, Лечение, Подготовка)              │
│  2. Выбрать ОДНО завершающее действие:                          │
│     ┌─────────────┬─────────────┬─────────────┐                 │
│     │ ⚔️ АТАКА    │ 💬 ВЛИЯНИЕ  │ ⏳ ОЖИДАНИЕ │                 │
│     │ → HP врага  │ → WP врага  │ → Экономия  │                 │
│     │ Карта Судьбы│ Карта Судьбы│ Без Судьбы  │                 │
│     └─────────────┴─────────────┴─────────────┘                 │
└─────────────────────────┬───────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│  ФАЗА 2: РАЗРЕШЕНИЕ ВРАГА                                       │
│  ────────────────────────                                       │
│  1. Враг выполняет своё Намерение                               │
│  2. Если Намерение = Атака:                                     │
│     → Автоматическая проверка защиты (Карта Судьбы)            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
                    [Следующий раунд или Конец боя]
```

### Фаза 0: Объявление намерения

В начале каждого раунда враг **объявляет**, что он будет делать.

| Иконка | Тип | Описание |
|--------|-----|----------|
| ⚔️ | `attack(X)` | Нанесёт X урона |
| 🛡️ | `defend(Y)` | Получает +Y брони на раунд |
| 💬 | `argument` | Восстанавливает WP (защита воли) |
| 💀 | `ritual` | Сдвигает резонанс к Нави |
| 🔥 | `prepare` | Пропускает ход, следующая атака ×2 (Ярость) |
| ❤️ | `heal(Z)` | Восстанавливает Z HP |
| 👥 | `summon` | Призывает подкрепление |

**Требование UI:** Иконка намерения появляется над врагом в начале раунда, до действий игрока.

> **Частота вытягивания Судьбы:** Карта Судьбы тянется только на "Завершающее действие" (один раз за ход игрока: Атака/Влияние/Ожидание) и на Защиту при `attack(X)` намерении. Карты подготовки (Бафф, Лечение, Подготовка) не тянут Судьбу.

### Фаза 1: Действие игрока

Игрок тратит **Энергию** на розыгрыш карт из руки. В конце он выбирает **ОДНО** завершающее действие.

#### Система энергии (v1.1)

Каждый ход игрок получает фиксированное количество энергии (по умолчанию 3). Каждая разыгранная карта стоит `card.cost` энергии (по умолчанию 1). Если энергии недостаточно — карта не может быть разыграна.

```
Начало хода → energy = maxEnergy (3)
Розыгрыш карты → energy -= card.cost ?? 1
Недостаточно энергии → карта отклоняется (shake-анимация)
```

| Параметр | Значение | Настройка |
|----------|----------|-----------|
| Начальная энергия | 3 | `CombatNexusBuilder(playerEnergy:)` |
| Стоимость по умолчанию | 1 | `card.cost ?? 1` |
| Сброс энергии | Начало хода игрока | После `resolveEnemyTurn()` |

#### Exhaust-механика (v1.1)

Карты с `exhaust: true` после розыгрыша перемещаются в **exhaustPile** вместо сброса. Они не возвращаются в колоду при перемешивании. Это позволяет создавать мощные одноразовые карты.

#### Завершающее действие

| Действие | Цель | Эффект | Карта Судьбы? |
|----------|------|--------|---------------|
| **Атака (Тело)** | HP врага | Проверка Силы → Уменьшает HP | Да |
| **Влияние (Дух)** | WP врага | Проверка Воли → Уменьшает WP | Да |
| **Ожидание (Пропуск)** | — | Восстанавливает немного Веры | Нет (экономит карту) |

**Кнопка "Завершить ход" всегда доступна.** Ожидание — это валидный тактический выбор.

> **Правило реализации Ожидания:** Ожидание не триггерит никаких hidden draws и не меняет состояние Колоды Судьбы. Это гарантия для игрока, что "пропуск хода" не имеет скрытых side effects.

### Фаза 2: Разрешение врага

1. Враг выполняет своё объявленное **Намерение**
2. Если Намерение = `attack(X)`, игрок **должен защититься**
3. **Проверка защиты Судьбой** срабатывает автоматически (карта тянется из Колоды Судьбы)

---

## 3. Математика: Система проверок Судьбы

Вместо костей (d6) мы используем колоду карт. Значения карт могут быть **отрицательными и положительными** — конкретный диапазон определяется Content Pack и уровнем сложности.

**Базовое правило:** Значение карты **всегда добавляется** к статам игрока. Большее значение = лучший результат для игрока (и в атаке, И в защите).

> **Важно:** Карта Судьбы может быть отрицательной. Правило "всегда добавляется" означает только математическое сложение, а не гарантированное улучшение результата. Отрицательная карта ухудшит и атаку, и защиту.
>
> **Content Pack определяет:** Какие карты в колоде, их значения, распределение. Базовый Campaign Pack использует диапазон примерно -2..+3, но это не ограничение системы.

### 3.1 Формула атаки (Физическая / Путь убийства)

> **Маппинг статов:** `СилаИгрока` = `Мощь` (из четырёх базовых статов). Везде в формулах используется generic-термин для совместимости с разными героями.

```
ОбщаяАтака = СилаИгрока + БонусОружия + БонусОтКарт + Effort + КартаСудьбы
Урон = max(0, ОбщаяАтака - БроняВрага)
HPВрага -= Урон
```

> **Effort** — бонус от добровольного сброса карт из руки (0–2, §3.3a). Подробности — ниже.

**Пример:**
- Сила (3) + Меч (2) + Карта Судьбы (+1) = **6 Атаки**
- Броня врага: 4
- **Урон: 6 - 4 = 2 HP**

**Критический удар:** Если Карта Судьбы имеет символ `CRIT`, активируется особый эффект оружия.

### 3.2 Формула влияния (Духовная / Путь умиротворения)

> **Маппинг статов:** `ВоляИгрока` определяется полем `will_stat` в HeroDefinition:
> ```json
> { "will_stat": "word" | "sense" }  // default = "word"
> ```
> Engine читает `hero.will_stat` и использует соответствующий стат для формулы Влияния.

```
ОбщееВлияние = ВоляИгрока + БонусУбеждения + БонусОтКарт + Effort + КартаСудьбы
ДуховныйУрон = max(0, ОбщееВлияние - ДуховнаяБроняВрага)
WPВрага -= ДуховныйУрон
```

**Примечание:** Большинство врагов имеют высокую Броню, но низкую Духовную Броню (или наоборот). Это создаёт стратегический выбор.

### 3.3 Формула защиты (Активная защита)

Срабатывает автоматически, когда враг атакует.

```
ОбщаяЗащита = БроняИгрока + БонусЩита + КартыЗащиты + КартаСудьбы
ВходящийУрон = max(0, Намерение.значение - ОбщаяЗащита)
HPИгрока -= ВходящийУрон
```

**Пример:**
- Намерение врага: Атака (8)
- Броня игрока (2) + Щит (3) + Карта Судьбы (+2) = **7 Защиты**
- **Входящий урон: 8 - 7 = 1 HP потеряно**

**Критическая защита:** Если Карта Судьбы имеет символ `CRIT` при защите, игрок получает 0 урона (полное уклонение).

> **Заметка дизайна (v1.0):** Текущая формула позволяет 0 урона, если защита превышает атаку. Это намеренно для простоты MVP.
> **Будущее рассмотрение (v2.0+):** Рассмотреть правило "Минимальный урон", где атаки всегда наносят минимум 1 урона, если не сработала Критическая защита. Это предотвращает бессмертные "танковые" билды.

### 3.3a Механика Effort (Усилие)

**Каноническая формула** (PROJECT_BIBLE, GDD §9.2): `Fate Test = Stat + FateCard + Effort >= Difficulty`

**Определение:** Effort — добровольный сброс карт из руки для усиления Fate-проверки. Каждая сброшенная карта даёт **+1 к итоговому значению теста**.

| Правило | Значение |
|---|---|
| Когда | Фаза `playerAction`, до commit |
| Что можно сбросить | Любая карта из руки, кроме выбранной для действия |
| Бонус | +1 за карту (линейно) |
| Жёсткий лимит | **Max 2 карты за commit** (default; `HeroDefinition.maxEffort` может переопределить) |
| Стоимость энергии | Нет — Effort не тратит Faith |
| Куда уходит карта | `discardPile` (не `exhaustPile`) |
| Отмена | До commit — карту можно вернуть |

**Применимость:**

| Тип Fate Test | Effort применяется |
|---|---|
| Attack (`commitAttack`) | Да |
| Influence (`commitInfluence`) | Да |
| Defense (автоматическая) | Нет |
| Wait/Skip | Нет |

**Реализация:** `CombatCalculator.calculateAttackWithFate(effortCards:)` уже включает Effort в формулу. API расширения `CombatSimulation` — см. ENGINE_ARCHITECTURE.md §E.5.

> **Подробный дизайн:** `plans/2026-02-13-ritual-combat-design.md` §3.5

### 3.4 Механика выбора Карты Судьбы

Некоторые особые Карты Судьбы предлагают **выбор** при вытягивании:

```
┌─────────────────────────────────────────────────┐
│  🌙 ШЁПОТ ДРЕВНИХ                               │
├─────────────────────────────────────────────────┤
│  Вариант A (Безопасный):  +1 модификатор        │
│  Вариант B (Рискованный): +4 модификатор        │
│                           НО: Резонанс -10 (Навь)│
└─────────────────────────────────────────────────┘
```

- Только карты с `type: "choice"` вызывают этот UI
- Большинство карт разрешаются автоматически (без popup)
- Создаёт драматические моменты без замедления каждого вытягивания

### 3.5 Универсальные ключевые слова Судьбы (Контекстная интерпретация)

**Принцип:** Колода Судьбы — единый «язык», на котором игра разговаривает с игроком во всех ситуациях. Одна колода работает везде через **контекстную интерпретацию**.

> **Правило глобальной колоды:** Колода Судьбы **глобальна для сессии кампании**. Все контексты (бой, дипломатия, исследование, квесты) берут карты из одного состояния колоды. Любой draw/peek/reorder меняет единую колоду и сохраняется в save.

#### 3.5.1 Анатомия Карты Судьбы (Универсальный дизайн)

Каждая карта имеет 4 слоя информации:

```json
{
  "id": "fate_wolf_moon",
  "value": 2,                  // Математика: Всегда +2 к проверке
  "suit": "nav",               // Аспект: Навь (Хаос, Агрессия, Интуиция)
  "keyword": "surge",          // Эффект: Всплеск / Прорыв
  "intensity": 5               // Потенциал сдвига (направление определяется контекстом!)
}
```

| Слой | Описание | Универсальность |
|------|----------|-----------------|
| `value` | Математический модификатор | Одинаков везде: +N к проверке |
| `suit` | Аспект (nav/prav/yav) | Определяет Match Bonus и направление сдвига |
| `keyword` | Эффект-ключевое слово | Интерпретируется по контексту |
| `intensity` | Потенциал сдвига резонанса | **Направление** зависит от Synergy/Dissonance |

> **Принцип относительности резонанса:** Карты не имеют "добра" или "зла". Они имеют **Аспект (Навь/Правь/Явь)**.
> - **Synergy (совпадение):** Аспект карты = аспект Героя/Действия → стабильный эффект, малый сдвиг (`intensity × synergyMultiplier`)
> - **Dissonance (конфликт):** Аспект противоположен → мощный нестабильный эффект, **сильный** сдвиг (`intensity × dissonanceMultiplier`) в сторону карты
> - Герой Нави использует карту Нави в бою → Synergy, мир мягко сдвигается в Навь
> - Герой Прави использует карту Нави → Dissonance, мир резко ломается в Навь (штраф за "запретную" силу)

#### 3.5.2 Порядок применения эффектов (Resolution Order)

```
   ┌─────────────────────────────────────────────────────────┐
   │              РЕЗОЛЮЦИЯ КАРТЫ СУДЬБЫ                     │
   │         (Канонический порядок — Engine MUST follow)     │
   └─────────────────────────────────────────────────────────┘
                              │
                              ▼
   ┌─────────────────────────────────────────────────────────┐
   │ 1. ВЫТЯНУТЬ                                             │
   │    Получаем карту (value/suit/keyword/intensity)        │
   └─────────────────────────────────────────────────────────┘
                              │
                              ▼
   ┌─────────────────────────────────────────────────────────┐
   │ 2. ПРОВЕРКА СОВМЕСТИМОСТИ                               │
   │    Аспект карты vs Аспект героя/действия               │
   │    → Synergy / Dissonance / Neutral                     │
   └─────────────────────────────────────────────────────────┘
                              │
                              ▼
   ┌─────────────────────────────────────────────────────────┐
   │ 3. ЗНАЧЕНИЕ (VALUE)                                     │
   │    Стат + value → результат проверки                    │
   └─────────────────────────────────────────────────────────┘
                              │
                              ▼
   ┌─────────────────────────────────────────────────────────┐
   │ 4. КЛЮЧЕВОЕ СЛОВО (KEYWORD)                            │
   │    Контекстный resolver интерпретирует эффект           │
   └─────────────────────────────────────────────────────────┘
                              │
                              ▼
   ┌─────────────────────────────────────────────────────────┐
   │ 5. РЕЗОНАНС (ПОСЛЕДНИМ!)                               │
   │    intensity × multiplier → сдвиг мира                  │
   │    Synergy: ×0.5 | Dissonance: ×1.5                     │
   │    (значения из Balance Pack, см. Приложение C)         │
   └─────────────────────────────────────────────────────────┘
```

> **Требование Gate-теста:** `testFateCardResolutionOrder` должен проверять этот порядок.

#### 3.5.3 Матрица интерпретации (Interpretation Matrix)

Engine берёт `keyword` карты и применяет его к текущему `ActionContext`.

**Пример карты: "Волчья Луна" (suit: nav, value: +2, keyword: surge)**

| Контекст | Действие | Интерпретация Engine | Нарратив |
|----------|----------|----------------------|----------|
| **COMBAT_PHYSICAL** | Атака мечом | +2 урон + Кровотечение | *"Твоя рука движется неестественно быстро"* |
| **COMBAT_SPIRITUAL** | Влияние | +2 влияние, но NPC пугается | *"В твоём голосе звучит рык"* |
| **EXPLORATION** | Взлом замка | +2 к проверке, но громкий звук | *"Ты срываешь замок грубой силой"* |
| **DEFENSE** | Блок удара | +2 защита + контратака 1 урон | *"Ты принимаешь удар, чтобы ударить в ответ"* |

#### 3.5.4 Match Bonus (Резонансное совпадение)

```
            MATCH BONUS (Резонансное совпадение)

   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │    НАВЬ     │     │     ЯВЬ     │     │   ПРАВЬ     │
   │   (Тьма)    │     │ (Сумерки)   │     │   (Свет)    │
   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │ • Атака     │     │ Нейтрально  │     │ • Лечение   │
   │ • Запугива- │     │ ко всем     │     │ • Дипломатия│
   │   ние       │     │ действиям   │     │ • Защита    │
   │ • Воровство │     │             │     │ • Знание    │
   │ • Риск      │     │             │     │             │
   └─────────────┘     └─────────────┘     └─────────────┘

   ═══════════════════════════════════════════════════════

   MATCH (совпадение):      keyword × matchMultiplier
   MISMATCH (несовпадение): только value, возможен side effect
```

**Механика:**
- **Match (масть = действие):** Эффект keyword срабатывает с множителем `combat.balance.matchMultiplier` (default 1.5)
- **Mismatch (масть ≠ действие):** Только голое `value`, keyword может дать side effect

```swift
// Engine pseudo-code
func resolveMatchBonus(card: FateCard, context: ActionContext) -> MatchResult {
    if card.suit.matches(context.actionType) {
        return .fullEffect(multiplier: 1.5)
    } else if card.suit.opposes(context.actionType) {
        return .valueOnly(sideEffect: .negative)
    }
    return .standard
}
```

#### 3.5.5 Базовые ключевые слова (5 универсальных)

| Keyword | Значение | Бой | Дипломатия/Квесты | Исследование |
|---------|----------|-----|-------------------|--------------|
| **SURGE** | Всплеск/Прорыв | Доп. урон, Кровотечение | Давление, -Репутация | Успех с шумом |
| **FOCUS** | Точность | Игнор брони | Раскрытие скрытой инфо | Находит секрет |
| **ECHO** | Повторение | Карта в руку | +Репутация, +Вера | Повтор действия |
| **SHADOW** | Тень/Цена | Вампиризм (лечение) | Успех + сдвиг к Нави | Скрытность |
| **WARD** | Оберег | Щит | Предотвращение провала | Защита от ловушки |

#### 3.5.6 Стратегическая глубина

**Почему это важно для игрока:**
1. Игрок запоминает карты: *"Вышла 'Кровавая капля'. В бою она лечит, в диалоге заставит хамить. Придержу для боя."*
2. Судьба едина, но проявляется по-разному — усиливает нарратив
3. Экономия ассетов: одна колода на всю игру

#### 3.5.7 Заметка реализации

```swift
// OutcomeResolver pattern
protocol KeywordResolver {
    func resolve(keyword: FateKeyword, context: ActionContext, value: Int) -> FateOutcome
}

// Контекстные резолверы
class CombatKeywordResolver: KeywordResolver { ... }
class DiplomacyKeywordResolver: KeywordResolver { ... }
class ExplorationKeywordResolver: KeywordResolver { ... }
```

Engine выбирает resolver по `ActionContext` и делегирует интерпретацию keyword.

---

## 4. Влияние Резонанса

Глобальная шкала Навь/Правь (-100 до +100) влияет на бой через **модификаторы окружения**.

### 4.1 Таблица эффектов зон

| Зона резонанса | Диапазон | Боевые эффекты |
|----------------|----------|----------------|
| **Глубокая Навь** | -100 до -60 | • Карты Света/Прави стоят +1 Веры<br>• Карты Нави получают Эхо (возврат в руку)<br>• Враги наносят +1 урона<br>• Нежить регенерирует +1 HP/ход |
| **Навь** | -59 до -20 | • Карты Света стоят +1 Веры<br>• Способности Тьмы усилены |
| **Явь (Сумерки)** | -19 до +19 | • Без модификаторов (баланс) |
| **Правь** | +20 до +59 | • Тёмные карты стоят +1 Веры<br>• Лечение усилено +1 |
| **Глубокая Правь** | +60 до +100 | • Нельзя использовать Скрытность/Разбойные карты<br>• Лечение усилено +2<br>• Нежить получает 1 урон/ход<br>• Тёмные карты стоят +2 Веры |

### 4.2 Система аффинити карт

Каждая карта имеет опциональный тег `affinity`:

```json
{
  "id": "shadow_strike",
  "affinity": "nav",
  "base_cost": 2
}
```

**Расчёт стоимости:**
```swift
func adjustedCost(card: Card, worldResonance: Float) -> Int {
    guard let affinity = card.affinity else { return card.baseCost }

    let zone = ResonanceEngine.zone(for: worldResonance)

    switch (affinity, zone) {
    case (.nav, .deepPrav), (.nav, .prav):
        return card.baseCost + (zone == .deepPrav ? 2 : 1)
    case (.prav, .deepNav), (.prav, .nav):
        return card.baseCost + (zone == .deepNav ? 2 : 1)
    default:
        return card.baseCost
    }
}
```

---

## 5. Переходы: Бой ↔ Дипломатия

Игрок может менять тактику в середине боя, но это требует преодоления **инерции конфликта**.

### 5.1 Деэскалация (Бой → Дипломатия)

**Ситуация:** Вы атаковали мечом, но понимаете, что враг слишком силён (или Резонанс дрейфует не туда), хотите договориться.

**Проблема:** Враг в ярости (Aggro State).

**Механика:**
1. Шкала Духа (WP) получает временный щит: **"Щит Ярости"** (+X к защите WP)
2. Чтобы начать диалог, нужно сначала пробить этот щит с помощью:
   - Карт контроля (Оглушение, Успокоение)
   - Блокирования несколько ходов без атак (демонстрация мирных намерений)

```
┌─────────────────────────────────────────────────┐
│  СТОИМОСТЬ ДЕЭСКАЛАЦИИ                          │
├─────────────────────────────────────────────────┤
│  После атаки Тела:                              │
│  • Враг получает ЩИТ_ЯРОСТИ на WP               │
│  • Щит = СилаВрага × ХодовВБою × rageShieldFactor│
│  • Нужно истощить щит, прежде чем можно         │
│    наносить урон WP                             │
└─────────────────────────────────────────────────┘
```

### 5.2 Эскалация (Дипломатия → Бой)

**Ситуация:** Вы пытались убедить стражника, но карты не в вашу пользу. Решаете атаковать.

**Проблема:** Внезапная агрессия бесчестна.

**Механика:**
1. Первая атака по Телу наносит **×1.5 урона** (Внезапная атака)
2. **Штраф:** Немедленный сдвиг Резонанса **-15 к Нави**
3. **Штраф:** Враг входит в состояние Ярости (следующая атака ×1.5)

```
┌─────────────────────────────────────────────────┐
│  СТОИМОСТЬ ЭСКАЛАЦИИ                            │
├─────────────────────────────────────────────────┤
│  При переключении с атак Духа на атаки Тела:   │
│  • Первая атака: ×1.5 урона (Внезапность)      │
│  • Резонанс: -15 (к Нави)                       │
│  • Враг: Ярость (следующая атака ×1.5)         │
│                                                 │
│  Это моральный выбор, не только тактический!   │
└─────────────────────────────────────────────────┘
```

---

## 6. Структуры данных

### 6.1 Определение врага (Обновлённый `enemies.json`)

```json
{
  "id": "leshy",
  "name": {
    "en": "Leshy",
    "ru": "Леший"
  },
  "description": {
    "en": "Ancient forest guardian...",
    "ru": "Древний страж леса..."
  },
  "stats": {
    "hp_max": 15,
    "wp_max": 8,
    "armor_physical": 2,
    "armor_spirit": 0,
    "power": 4,
    "influence": 2
  },
  "behavior_id": "behavior_forest_guardian",
  "resonance_affinity": "nav",
  "resonance_modifiers": {
    "deepNav": {"power": 2, "armor_physical": 1, "hp_max": 10},
    "nav": {"power": 1, "hp_max": 5},
    "yav": {},
    "prav": {"power": -1, "hp_max": -5},
    "deepPrav": {"power": -2, "armor_physical": -1, "hp_max": -10}
  },
  "loot": {
    "kill": ["beast_hide", "spirit_essence"],
    "pacify": ["forest_blessing", "leshy_pact"]
  },
  "rewards": {
    "kill": {"faith": 5, "resonance": -10},
    "pacify": {"faith": 3, "resonance": 10}
  }
}
```

### 6.1.1 Паттерны врагов (EchoEngine, v1.1)

Помимо rule-based поведений (`behaviors.json`), EchoEngine поддерживает упрощённые **циклические паттерны** через поле `pattern` в `EnemyDefinition`:

```json
{
  "id": "risen_dead",
  "pattern": [
    {"type": "attack", "value": 4},
    {"type": "attack", "value": 4},
    {"type": "block", "value": 0}
  ]
}
```

**Механика:** `pattern[(round - 1) % pattern.count]` — враг циклически повторяет последовательность действий.

**Типы шагов:** `attack`, `block`, `heal`, `ritual`

Паттерны — это альтернатива `behavior_id` для простых врагов без сложной AI-логики. Если у врага есть и `behavior_id`, и `pattern`, приоритет имеет `behavior_id`.

### 6.2 Определение поведения (Новый `behaviors.json`)

> **Заметка реализации:**
> - Engine должен загружать `behaviors.json` **до** `enemies.json`, ИЛИ поддерживать ленивое разрешение ссылок `behavior_id`.
> - Если враг ссылается на несуществующее поведение, `ContentValidator` должен **fail fast** (жёсткая ошибка). Тихий fallback на default_behavior недопустим — сломанный контент должен валиться на этапе валидации.
> - См. задачу **E9** в Задачах реализации.

```json
{
  "id": "behavior_forest_guardian",
  "description": "Стандартное поведение лесного духа",
  "default_intent": "attack_normal",
  "rules": [
    {
      "priority": 100,
      "condition": {
        "type": "hp_percent",
        "operator": "<",
        "value": 30
      },
      "intent": "heal_roots",
      "comment": "Лечиться при критическом ранении"
    },
    {
      "priority": 90,
      "condition": {
        "type": "player_attacking_wp",
        "value": true
      },
      "intent": "argument_restore",
      "comment": "Защищать волю при влиянии",
      "_note": "Требует CombatState.lastPlayerActionType flag в engine"
    },
    {
      "priority": 80,
      "condition": {
        "type": "world_resonance",
        "operator": "<",
        "value": -50
      },
      "intent": "ritual_nav",
      "comment": "Тёмный ритуал в Глубокой Нави"
    },
    {
      "priority": 50,
      "type": "weighted_random",
      "pool": [
        {"intent": "attack_normal", "weight": 3},
        {"intent": "attack_heavy", "weight": 1},
        {"intent": "defend_bark", "weight": 1}
      ],
      "comment": "Обычный цикл поведения"
    }
  ],
  "intents": {
    "attack_normal": {
      "type": "attack",
      "value_formula": "power",
      "description": {"en": "Claw Swipe", "ru": "Удар Когтями"}
    },
    "attack_heavy": {
      "type": "attack",
      "value_formula": "power * heavyAttackMultiplier",
      "description": {"en": "Crushing Blow", "ru": "Сокрушительный Удар"}
    },
    "defend_bark": {
      "type": "defend",
      "value": 4,
      "description": {"en": "Bark Armor", "ru": "Кора Защиты"}
    },
    "heal_roots": {
      "type": "heal",
      "value": 5,
      "description": {"en": "Root Regeneration", "ru": "Регенерация Корней"}
    },
    "argument_restore": {
      "type": "restore_wp",
      "value": 3,
      "description": {"en": "Ancient Will", "ru": "Древняя Воля"}
    },
    "ritual_nav": {
      "type": "ritual",
      "resonance_shift": -5,
      "description": {"en": "Dark Invocation", "ru": "Тёмный Ритуал"}
    }
  }
}
```

> **Ограничение value_formula:** Поле `value_formula` поддерживает **только whitelist** форм:
> - `"power"` — базовая сила врага
> - `"power * MULTIPLIER_ID"` — где MULTIPLIER_ID должен существовать в Balance Pack (например `combat.balance.heavyAttackMultiplier`)
> - `"influence"` — базовое влияние врага
> - `"hp_percent"` — процент текущего HP
>
> Примеры валидных формул:
> - `"power"` ✓
> - `"power * heavyAttackMultiplier"` ✓ (если ключ существует в balance)
> - `"power * 1.5"` ✗ (hardcoded значение запрещено)
>
> `ContentValidationTests` проверяет: (1) форма в whitelist, (2) MULTIPLIER_ID существует в Balance Pack.

### 6.3 Определение Карты Судьбы (Обновлённый `fate_deck.json`)

> **Универсальный дизайн:** Каждая карта содержит `keyword` для контекстной интерпретации (см. §3.5). Карта не описывает конкретный эффект — Engine интерпретирует keyword по ActionContext.

```json
{
  "id": "fate_whisper_ancients",
  "name": {
    "en": "Whisper of the Ancients",
    "ru": "Шёпот Древних"
  },
  "suit": "nav",
  "base_value": 1,
  "keyword": "shadow",
  "intensity": 2,
  "type": "choice",
  "choice_option": {
    "text": {
      "en": "Invoke the power",
      "ru": "Призвать силу"
    },
    "bonus_value": 3,
    "intensity": 10,
    "visual_effect": "dark_flash"
  },
  "resonance_rules": [
    {
      "zone": "deepNav",
      "modify_value": 1,
      "visual_effect": "shadow_pulse"
    }
  ],
  "is_critical": false,
  "narrative_hint": {
    "en": "Darkness whispers secrets",
    "ru": "Тьма шепчет тайны"
  }
}
```

**Обязательные поля для Universal Fate:**

| Поле | Тип | Описание |
|------|-----|----------|
| `suit` | enum | nav / prav / yav — определяет Match Bonus |
| `base_value` | int | Математический модификатор (диапазон определяется Content Pack) |
| `keyword` | enum | surge / focus / echo / shadow / ward — контекстный эффект |
| `intensity` | int | Потенциал сдвига резонанса (направление определяется Synergy/Dissonance) |
| `narrative_hint` | localized | Текст для лога/UI (не описание эффекта!) |

### 6.4 Enum FateKeyword (Engine)

```swift
public enum FateKeyword: String, Codable, Equatable {
    case surge   // Всплеск: доп. урон / давление / шум
    case focus   // Фокус: игнор брони / reveal info / находит секрет
    case echo    // Эхо: карта в руку / +reputation / повтор
    case shadow  // Тень: вампиризм / скрытность / цена
    case ward    // Оберег: щит / prevent fail / защита от ловушки
}
```

### 6.5 Enum IntentType (Engine)

```swift
public enum IntentType: String, Codable, Equatable {
    case attack          // Урон по HP игрока
    case defend          // Временная броня
    case heal            // Восстановление HP врага
    case restoreWP       // Восстановление WP врага (аргумент)
    case ritual          // Сдвиг резонанса к Нави
    case prepare         // Пропуск хода, усиление следующей атаки
    case summon          // Призыв подкреплений (будущее)
    case debuff          // Негативный эффект на игрока
    case buff            // Позитивный эффект на себя
}
```

### 6.6 Enum ActionContext (Engine)

```swift
public enum ActionContext: String, Codable {
    case combatPhysical    // Атака Тела
    case combatSpiritual   // Атака Духа/Влияние
    case defense           // Защита от атаки врага
    case exploration       // Исследование, взлом, поиск
    case dialogue          // Диалог, дипломатия
    case skillCheck        // Проверка навыка (не в бою)
}
```

---

## 7. Требования к UI/UX

### 7.1 Макет боевого HUD

```
┌─────────────────────────────────────────────────────────┐
│  [Виджет Резонанса: ☽━━━●━━━━━━☀ +12 Явь]             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│                    ┌─────────┐                          │
│                    │  ⚔️ 8   │ ← Значок намерения       │
│                    └────┬────┘                          │
│                         │                               │
│              ┌──────────┴──────────┐                    │
│              │   [СПРАЙТ ВРАГА]    │                    │
│              │                     │                    │
│              │  ████████░░░░ 12/20 │ ← Полоса HP (Красн)│
│              │  ████░░░░░░░░  4/10 │ ← Полоса WP (Син) │
│              └─────────────────────┘                    │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  ┌──────┐                                               │
│  │ ✨3  │ ← Счётчик Веры                               │
│  └──────┘                                               │
│                                                         │
│  [Карта 1] [Карта 2] [Карта 3] [Карта 4] [Карта 5]     │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  [ ⚔️ Атака ]  [ 💬 Влияние ]  [ ⏳ Ожидание ]         │
│                                                         │
│  [Колода Судьбы: 🎴 8]  [Сброс: 📚 4]                  │
└─────────────────────────────────────────────────────────┘
```

### 7.2 Визуальные требования

| Элемент | Требование |
|---------|------------|
| **Иконка намерения** | Всегда видна над головой врага. Размер: минимум 32×32pt. Анимация при изменении. |
| **Полоса HP** | Красная (#FF4444). Показывает текущее/максимум. |
| **Полоса WP** | Синяя (#4488FF). Показывает текущее/максимум. Под полосой HP. |
| **Кнопка Ожидания** | Должна быть визуально равна Атаке/Влиянию. Это валидная тактика, не "пропуск". |
| **Виджет Резонанса** | Компактный режим в бою. Показывает иконку + значение. Фон тонируется к Нави (фиолетовый) или Прави (золотой). |
| **Анимация вытягивания Судьбы** | Должна быть удовлетворяющей (как бросок костей). Показывать: `База (5) + Карта (+2) = Итого (7)` |
| **Вытягивание защиты** | Та же анимация, что и атака, но срабатывает автоматически во время фазы врага. |

### 7.3 UI выбора Карты Судьбы

Когда вытягивается карта с `type: "choice"`:

```
┌─────────────────────────────────────────────────────────┐
│           🌙 ШЁПОТ ДРЕВНИХ                              │
│                                                         │
│  ┌───────────────────┐   ┌───────────────────┐         │
│  │   Вариант A       │   │   Вариант B       │         │
│  │                   │   │                   │         │
│  │   Безопасно: +1   │   │   Риск: +4        │         │
│  │                   │   │   Резонанс -10    │         │
│  │   [  Принять  ]   │   │   [  Принять  ]   │         │
│  └───────────────────┘   └───────────────────┘         │
│                                                         │
│                    [Таймер: 3с]                         │
└─────────────────────────────────────────────────────────┘
```

- Авто-выбор Варианта A при истечении таймера (безопасный default)
- Анимация: карта всплывает, разделяется на два выбора

> **Политика UI:** Таймер 3с и авто-выбор — это UI policy, не engine rule. Параметры:
> - `ui.fateChoice.timerDuration` (default 3с, 0 = отключён)
> - `ui.fateChoice.autoSelectSafe` (default true)
> - В настройках доступности таймер может быть отключён или увеличен.
>
> **Поведение при отключённом таймере:** При отключённом таймере (`timerDuration = 0`) выбор всегда ручной. Engine получает результат выбора от UI, но не управляет временем ожидания.

---

## 8. Задачи реализации

### 8.1 Задачи Engine

| ID | Задача | Приоритет | Файлы |
|----|--------|-----------|-------|
| E1 | Обновить `EnemyDefinition.swift` с `wp_max`, `armor_spirit` | ВЫСОКИЙ | `EnemyDefinition.swift` |
| E2 | Создать `BehaviorDefinition.swift` для паттернов намерений | ВЫСОКИЙ | Новый файл |
| E3 | Обновить `EnemyIntentGenerator` для использования JSON поведений | ВЫСОКИЙ | `EnemyIntent.swift` |
| E4 | Реализовать `CombatResolver` с двухшкальным уроном | ВЫСОКИЙ | Новый файл |
| E5 | Добавить тип `FateCardChoice` в `FateCard.swift` | СРЕДНИЙ | `FateCard.swift` |
| E6 | Реализовать штрафы эскалации/деэскалации | СРЕДНИЙ | `TwilightGameEngine.swift` |
| E7 | Добавить модификаторы стоимости резонанса к розыгрышу карт | СРЕДНИЙ | `TwilightGameEngine.swift` |
| E8 | Добавить `lastPlayerActionType` (Body/Spirit) в CombatState | ВЫСОКИЙ | `TwilightGameEngine.swift` |
| E9 | Реализовать `BehaviorRegistry` с ленивым разрешением + жёсткая ошибка при отсутствующих ссылках (без fallback) | ВЫСОКИЙ | Новый файл |
| E10 | Добавить enum `FateKeyword` и поле `keyword` в FateCard | ВЫСОКИЙ | `FateCard.swift` |
| E11 | Создать протокол `KeywordResolver` + контекстные резолверы (Combat/Diplomacy/Exploration) | ВЫСОКИЙ | Новые файлы |
| E12 | Реализовать логику Match Bonus (масть соответствует типу действия) | СРЕДНИЙ | `FateDrawResolver.swift` |
| E13 | Добавить enum `ActionContext` | ВЫСОКИЙ | Новый файл |

### 8.2 Задачи UI

| ID | Задача | Приоритет | Файлы |
|----|--------|-----------|-------|
| U1 | Создать `DualHealthBar.swift` (отображение HP + WP) | ВЫСОКИЙ | Новый файл |
| U2 | Обновить `EnemyIntentView` со всеми типами намерений | ВЫСОКИЙ | `EnemyIntentView.swift` |
| U3 | Создать `FateCardChoiceSheet.swift` | СРЕДНИЙ | Новый файл |
| U4 | Обновить `CombatView` с новым потоком фаз | ВЫСОКИЙ | `CombatView.swift` |
| U5 | Добавить анимацию защитной Судьбы | СРЕДНИЙ | `FateCardRevealView.swift` |
| U6 | Добавить кнопку "Ожидание" с равным приоритетом | ВЫСОКИЙ | `CombatView.swift` |

### 8.3 Задачи данных

| ID | Задача | Приоритет | Файлы |
|----|--------|-----------|-------|
| D1 | Обновить `enemies.json` с новой схемой | ВЫСОКИЙ | `enemies.json` |
| D2 | Создать `behaviors.json` | ВЫСОКИЙ | Новый файл |
| D3 | Обновить `fate_deck_core.json` с картами выбора | СРЕДНИЙ | `fate_deck_core.json` |
| D4 | Добавить ключи локализации | СРЕДНИЙ | `Localizable.strings` |
| D5 | Добавить `keyword` ко всем картам судьбы в fate_deck_core.json | ВЫСОКИЙ | `fate_deck_core.json` |
| D6 | Добавить множители ключевых слов в Balance Pack | СРЕДНИЙ | `balance.json` |

### 8.4 Задачи тестирования

| ID | Задача | Приоритет |
|----|--------|-----------|
| T1 | Unit-тест: Расчёт урона двойной шкалы | ВЫСОКИЙ |
| T2 | Unit-тест: Оценка правил поведения | ВЫСОКИЙ |
| T3 | Unit-тест: Штрафы эскалации/деэскалации | СРЕДНИЙ |
| T4 | Интеграционный тест: Полный боевой поток | ВЫСОКИЙ |
| T5 | Unit-тест: Штраф резонанса эскалации (-15 Навь при атаке Тела после Духа) | ВЫСОКИЙ |
| T6 | Unit-тест: Приоритет убийства (HP=0 переопределяет WP=0) | ВЫСОКИЙ |
| T7 | Unit-тест: Интерпретация ключевых слов по контексту (одна карта, разные эффекты) | ВЫСОКИЙ |
| T8 | Unit-тест: Match Bonus (масть соответствует типу действия = усиленный эффект) | ВЫСОКИЙ |
| T9 | Unit-тест: Все карты судьбы имеют валидный keyword | ВЫСОКИЙ |

---

## 9. Примеры и сценарии

### Пример 1: Выживание (Фокус на активной защите)

**Контекст:** Игрок (3 HP) против Медведя (Намерение: Атака 10)

**Мысли игрока:** "Я не могу атаковать. Я умру. Нужно выжить."

**Ход игры:**
1. Игрок разыгрывает карту "Уклонение" (+4 Защиты)
2. Игрок нажимает **[Ожидание]** — без атаки
3. Враг атакует (10 урона)
4. Карта Судьбы вытягивается для защиты: `+2`
5. Общая защита: 4 (карта) + 2 (Судьба) + 1 (Ловкость) = **7**
6. Входящий урон: 10 - 7 = **3 HP**

**Результат:** Игрок выживает с 0 HP (или 1 с Last Stand). Если бы игрок атаковал, у него не хватило бы Веры на "Уклонение" и он получил бы полные 10 урона.

### Пример 2: Провал дипломатии → Эскалация

**Контекст:** Игрок пытается убедить Стражника (Намерение: Насмешка, восстанавливает WP)

**Проблема:** WP стражника восстанавливается быстрее, чем игрок может его снизить.

**Решение:** "Забудь о разговорах." Игрок разыгрывает "Удар Кинжалом".

**Ход игры:**
1. Внезапная атака: База 4 × 1.5 = **6 урона по HP**
2. **Эффект:** Резонанс сдвигается **-15 (к Нави)**
3. Стражник входит в **Ярость** — следующая атака будет сильнее

**Эмерджентная история:** "Я хотел его пощадить, но не рассчитал силу заклинания и сжёг его дотла. Теперь деревня меня ненавидит."

### Пример 3: Путь умиротворения

**Контекст:** Леший (HP: 15, WP: 8) против Жреца

**Стратегия игрока:** Фокус на духовном уроне, чтобы сохранить баланс леса.

**Ход 1:**
- Игрок разыгрывает "Успокаивающие Слова" (+2 Влияния)
- Игрок выбирает **[Влияние]**
- Карта Судьбы: `+1`
- Итого: 3 (Воля) + 2 (Карта) + 1 (Судьба) = **6 Влияния**
- Духовная Броня Лешего: 0
- **Духовный урон: 6 - 0 = 6**
- WP Лешего: 8 → 2

**Ход 2:**
- Намерение Лешего: "Аргумент" (восстанавливает +3 WP)
- Игрок разыгрывает "Взгляд Души" (+3 Влияния)
- Игрок выбирает **[Влияние]**
- Карта Судьбы: `+2`
- Итого: 3 + 3 + 2 = **8 Влияния**
- **Духовный урон: 8** (overkill)
- WP Лешего: 2 → **0**

**Результат:** Леший **УМИРОТВОРЁН**
- Резонанс сдвигается **+10 к Прави**
- Добыча: карта "Благословение Леса", предмет "Пакт с Лешим"
- Леший становится потенциальным союзником в будущих событиях

---

## Приложение A: Справочник формул

```
# АТАКА (Игрок → HP Врага)
ОбщаяАтака = СилаИгрока + БонусОружия + БонусыКарт + Effort + КартаСудьбы
Урон = max(0, ОбщаяАтака - БроняВрага)

# ВЛИЯНИЕ (Игрок → WP Врага)
ОбщееВлияние = ВоляИгрока + БонусыВлияния + БонусыКарт + Effort + КартаСудьбы
ДуховныйУрон = max(0, ОбщееВлияние - ДуховнаяБроняВрага)

# ЗАЩИТА (Враг → HP Игрока)
ОбщаяЗащита = БроняИгрока + БонусыЩита + КартыЗащиты + КартаСудьбы
ВходящийУрон = max(0, Намерение.значение - ОбщаяЗащита)

# МОДИФИКАТОР СТОИМОСТИ РЕЗОНАНСА
if (card.affinity == "nav" && zone in [.prav, .deepPrav]):
    card.cost += (zone == .deepPrav ? 2 : 1)
if (card.affinity == "prav" && zone in [.nav, .deepNav]):
    card.cost += (zone == .deepNav ? 2 : 1)

# ШТРАФ ЭСКАЛАЦИИ (Дипломатия → Бой)
firstBodyAttack.damage *= surpriseMultiplier       // default 1.5
worldResonance += escalationResonanceShift         // default -15
enemy.state = .enraged                             // enrageMultiplier default 1.5

# ЩИТ ДЕЭСКАЛАЦИИ (Бой → Дипломатия)
rageShield = enemy.power * turnsInCombat * rageShieldFactor  // factor default 1
enemy.wpDefense += rageShield (временно)
```

---

## Приложение B: Ключи локализации

```
// Фазы боя
combat.phase.intent
combat.phase.player.action
combat.phase.enemy.resolution

// Типы намерений
combat.intent.attack
combat.intent.defend
combat.intent.heal
combat.intent.restore.wp
combat.intent.ritual
combat.intent.prepare
combat.intent.summon

// Действия
combat.action.attack.body
combat.action.attack.spirit
combat.action.wait
combat.action.wait.description

// Результаты
combat.result.killed
combat.result.pacified
combat.result.fled
combat.result.player.death

// Эскалация/Деэскалация
combat.escalation.surprise
combat.escalation.penalty
combat.deescalation.rage.shield
```

---

## Приложение C: Ключи Balance Pack

Все числовые значения в системе настраиваются через Balance Pack.
**Hardcoded значения в коде ЗАПРЕЩЕНЫ.**

### Боевые модификаторы

| Ключ | По умолчанию | Описание |
|------|--------------|----------|
| `combat.balance.escalationResonanceShift` | -15 | Штраф резонанса при эскалации |
| `combat.balance.surpriseMultiplier` | 1.5 | Множитель урона внезапной атаки |
| `combat.balance.enrageMultiplier` | 1.5 | Множитель ярости врага |
| `combat.balance.rageShieldFactor` | 1 | Фактор щита ярости |
| `combat.balance.heavyAttackMultiplier` | 1.5 | Множитель тяжёлой атаки |
| `combat.balance.deepCostPenalty` | deep=2, shallow=1 | Штраф стоимости карт в зонах |
| `combat.balance.matchMultiplier` | 1.5 | Множитель Match Bonus |

### Резонанс и Судьба

| Ключ | По умолчанию | Описание |
|------|--------------|----------|
| `fate.balance.synergyMultiplier` | 0.5 | Множитель сдвига при Synergy |
| `fate.balance.dissonanceMultiplier` | 1.5 | Множитель сдвига при Dissonance |

### UI параметры

| Ключ | По умолчанию | Описание |
|------|--------------|----------|
| `ui.fateChoice.timerDuration` | 3 | Таймер выбора (сек), 0 = отключён |
| `ui.fateChoice.autoSelectSafe` | true | Авто-выбор безопасного варианта |

---

---

## Приложение D: Стресс-аудит Fate Deck (2026-02-14)

Математический аудит распределения value/keyword/suit в `fate_deck_core.json` (12 карт).

### D.1 Распределение колоды

**Масти:** prav 5 (41.7%), yav 4 (33.3%), nav 3 (25.0%)
**baseValue:** E = +0.333, σ ≈ 1.37, диапазон [-2, +3]
**Keywords:** surge ×4 (все prav), shadow ×3 (все nav), focus ×2 (все yav), ward ×2 (prav+yav), echo ×1 (yav)

### D.2 effectiveValue по зонам резонанса

| Зона | E[effectiveValue] |
|---|---|
| deepNav (-100..-61) | **-0.917** |
| nav (-60..-21) | -0.333 |
| yav (-20..+20) | +0.333 |
| prav (+21..+60) | +0.917 |
| deepPrav (+61..+100) | **+1.500** |

Swing deepNav→deepPrav: **2.417 пунктов** (значимо при difficulty 5–8).

### D.3 Keyword EV по путям (suit match/mismatch)

Suit matching: nav↔combatPhysical (match), prav↔combatSpiritual (match). Mismatch → keyword suppressed (×0). Match → keyword × matchMultiplier.

> **Примечание:** SoT `combat.balance.matchMultiplier` = **1.5** (Приложение C). Код hardcodes 2.0 (F5). Числа ниже посчитаны с кодовым значением 2.0 — пропорции между путями сохраняются при любом множителе.

| Путь | E[keyword bonus] | Matched cards | Suppressed cards |
|---|---|---|---|
| Kill (combatPhysical) | **+0.75** dmg | 3/12 nav | 5/12 prav |
| Pacify (combatSpiritual) | **+0.917** dmg | 5/12 prav | 3/12 nav |

**Pacify получает на 22% больше keyword value.** Keyword-система встроенно компенсирует tempo-преимущество Kill-пути.

### D.4 Находки и риски

| ID | Sev | Находка | Статус |
|---|---|---|---|
| **F1** | P1 | **Surge suppressed at Kill.** Все 4 surge-карты — prav → MISMATCH при combatPhysical → keyword обнулён. Лучший damage keyword (+2 dmg) недоступен Kill-пути. Потенциальный feel-bad moment. | Open |
| **F2** | P1 | **Crit favors Pacify.** `fate_crit` (base +3, surge, prav): при Kill → +3 total (keyword suppressed); при Pacify → +5 total (keyword ×2). Crit на 67% эффективнее для Pacify. Противоинтуитивно. | Open |
| **F3** | P2 | **deepNav doom spiral.** `curse_navi` в deepNav: effectiveValue = **-4**. При str=5, diff=6: промах даже с max Effort(2). Curse sticky → permanent deck pollution. E[total Kill] в deepNav = -0.167 (отрицательный — в среднем промах). | Open |
| **F4** | P2 | **deepPrav snowball.** E[effectiveValue] = +1.5, prav-карты shift resonance +3..+5 → self-reinforcing. Самокоррекция через Kill→Nav работает, но только при осознанном выборе Kill. | Monitor |
| **F5** | P3 | **matchMultiplier hardcoded.** `matchMultiplier: Double = 2.0` — default parameter в `KeywordInterpreter.resolve()`. SoT (`combat.balance.matchMultiplier`, Приложение C) = **1.5**. Drift: код не читает SoT-ключ. Fix: подключить к BalancePack config. | Open |
| **F6** | P3 | **bonusValue потерян в формуле.** `KeywordEffect.bonusValue` (ward: +1 val, parry) не участвует в `CombatCalculator.calculateAttackWithFate()`. Ward при атаке даёт special "parry", но потребитель special-эффекта не идентифицирован. | Open |

### D.5 Рекомендации (не блокеры текущего эпика)

1. **F1/F2:** При первом контент-ревью рассмотреть: 1 surge-карту сделать yav или nav; crit сделать yav suit или без keyword.
2. **F3:** Cap resonance modifyValue для sticky-карт на ±1, или ввести пол effectiveValue (e.g., max(-2, effectiveValue)).
3. **F5:** Подключить `KeywordInterpreter` к существующему SoT-ключу `combat.balance.matchMultiplier` (default 1.5, Приложение C).
4. **F6:** Верифицировать, что `CombatSystem` в EchoEngine применяет `keywordEffect.bonusValue` и `special`. Если нет — потерянная механика.

> **Методология:** Полный перебор 12 карт × 5 зон × 2 пути × 5 keywords. Формулы из `CombatCalculator.swift`, keyword-матрица из `KeywordInterpreter.swift`, suit matching из `FateResolutionService.swift`.

---

**Документ утверждён для разработки боевой системы.**
**Версия:** 1.2
**Последнее обновление:** 2026-02-14
