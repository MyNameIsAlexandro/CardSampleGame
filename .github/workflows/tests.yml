# CI: Full Ecosystem Test & Build Pipeline
# Covers all SPM packages, app tests, and build validation

name: CI Pipeline

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]

jobs:
  # ──────────────────────────────────────────────
  # Job 1: SPM Package Tests (swift test, macOS)
  # ──────────────────────────────────────────────
  spm-packages:
    name: "SPM: ${{ matrix.package }}"
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - TwilightEngine
          - EchoEngine
          - EchoScenes
          - PackEditorKit
          - PackEditorApp
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Build & Test ${{ matrix.package }}
        run: swift test --package-path Packages/${{ matrix.package }}

  # ──────────────────────────────────────────────
  # Job 2: App Tests (xcodebuild, iOS)
  # ──────────────────────────────────────────────
  app-tests:
    name: App Tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: "Gate 1: Quality Gates"
        run: |
          xcodebuild test \
            -scheme CardSampleGame \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -only-testing:CardSampleGameTests/CodeHygieneTests \
            -only-testing:CardSampleGameTests/DesignSystemComplianceTests \
            -only-testing:CardSampleGameTests/ContrastComplianceTests \
            -only-testing:CardSampleGameTests/LocalizationValidatorTests \
            -only-testing:CardSampleGameTests/LocalizationCompletenessTests \
            -resultBundlePath TestResults/QualityGates.xcresult \
            | xcpretty

      - name: "Gate 2: Content Validation"
        run: |
          xcodebuild test \
            -scheme CardSampleGame \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -only-testing:CardSampleGameTests/ContentValidationTests \
            -only-testing:CardSampleGameTests/ConditionValidatorTests \
            -only-testing:CardSampleGameTests/ExpressionParserTests \
            -only-testing:CardSampleGameTests/ProfileGateTests \
            -only-testing:CardSampleGameTests/AuditGateTests \
            -resultBundlePath TestResults/ContentValidation.xcresult \
            | xcpretty

      - name: "Gate 3: Unit & View Tests"
        run: |
          xcodebuild test \
            -scheme CardSampleGame \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -only-testing:CardSampleGameTests/HeroRegistryTests \
            -only-testing:CardSampleGameTests/SaveLoadTests \
            -only-testing:CardSampleGameTests/ContentManagerTests \
            -only-testing:CardSampleGameTests/ContentRegistryTests \
            -only-testing:CardSampleGameTests/PackLoaderTests \
            -only-testing:CardSampleGameTests/HeroPanelTests \
            -resultBundlePath TestResults/UnitTests.xcresult \
            | xcpretty

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: app-test-results
          path: TestResults/

  # ──────────────────────────────────────────────
  # Job 3: Build Validation
  # ──────────────────────────────────────────────
  build-validation:
    name: "Build: ${{ matrix.target }}"
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: CardSampleGame
            destination: "platform=iOS Simulator,name=iPhone 15"
          - target: PackEditor
            destination: "platform=macOS"
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Build ${{ matrix.target }}
        run: |
          xcodebuild build \
            -scheme ${{ matrix.target }} \
            -destination '${{ matrix.destination }}' \
            | xcpretty

  # ──────────────────────────────────────────────
  # Job 4: Content Validation
  # ──────────────────────────────────────────────
  content-validation:
    name: Content JSON Lint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "Validating all JSON content files..."
          fail=0
          for f in $(find Packages/CharacterPacks Packages/StoryPacks -name '*.json' -type f); do
            if ! python3 -m json.tool "$f" > /dev/null 2>&1; then
              echo "❌ Invalid JSON: $f"
              fail=1
            fi
          done
          if [ "$fail" -eq 1 ]; then
            echo "JSON validation failed"
            exit 1
          fi
          echo "✅ All JSON files valid"

  # ──────────────────────────────────────────────
  # Final Gate
  # ──────────────────────────────────────────────
  all-gates-passed:
    name: All Gates Passed
    needs: [spm-packages, app-tests, build-validation, content-validation]
    runs-on: ubuntu-latest
    steps:
      - name: All gates passed
        run: echo "All CI gates passed successfully!"
