/// Файл: Packages/TwilightEngine/Sources/TwilightEngine/Combat/VulnerabilityRegistry.swift
/// Назначение: Registry of enemy vulnerability definitions with capped modifiers.
/// Зона ответственности: Store, query, and cap vulnerability modifiers for enemy types.
/// Контекст: Epic 22 — Systemic Asymmetry. INV-DC-035..038.

import Foundation

// MARK: - VulnerabilityRegistry

/// Registry of enemy vulnerability definitions.
/// INV-DC-038: No absolute vulnerability (modifier capped at ±5).
public struct VulnerabilityRegistry: Equatable, Sendable {
    private var definitions: [String: EnemyVulnerabilityDefinition]

    public static let maxModifier: Int = 5

    public init(definitions: [EnemyVulnerabilityDefinition] = []) {
        self.definitions = [:]
        for def in definitions {
            self.definitions[def.enemyType] = def
        }
    }

    /// Lookup modifier, clamped to ±maxModifier.
    public func modifier(
        enemyType: String,
        actionType: DispositionActionType,
        zone: ResonanceZone
    ) -> Int {
        guard let def = definitions[enemyType] else { return 0 }
        let raw = def.modifier(for: actionType, in: zone)
        return min(Self.maxModifier, max(-Self.maxModifier, raw))
    }

    /// Register a definition.
    public mutating func register(_ definition: EnemyVulnerabilityDefinition) {
        definitions[definition.enemyType] = definition
    }

    /// Standard test dataset with 5 enemy types per SPRINT requirements.
    public static func makeTestDataset() -> VulnerabilityRegistry {
        var registry = VulnerabilityRegistry()

        registry.register(EnemyVulnerabilityDefinition(
            enemyType: "бандит",
            modifiers: [
                VulnerabilityModifier(actionType: .influence, zone: .yav, modifier: 2),
                VulnerabilityModifier(actionType: .strike, zone: .nav, modifier: -2)
            ]
        ))

        registry.register(EnemyVulnerabilityDefinition(
            enemyType: "дух",
            modifiers: [
                VulnerabilityModifier(actionType: .sacrifice, zone: .nav, modifier: 3),
                VulnerabilityModifier(actionType: .sacrifice, zone: .prav, modifier: -3)
            ]
        ))

        registry.register(EnemyVulnerabilityDefinition(
            enemyType: "зверь",
            modifiers: [
                VulnerabilityModifier(actionType: .strike, zone: .nav, modifier: 2),
                VulnerabilityModifier(actionType: .influence, zone: .prav, modifier: 2)
            ]
        ))

        registry.register(EnemyVulnerabilityDefinition(
            enemyType: "торговец",
            modifiers: [
                VulnerabilityModifier(actionType: .strike, zone: .nav, modifier: -1),
                VulnerabilityModifier(actionType: .strike, zone: .yav, modifier: -1),
                VulnerabilityModifier(actionType: .strike, zone: .prav, modifier: -1),
                VulnerabilityModifier(actionType: .influence, zone: .yav, modifier: 3)
            ]
        ))

        registry.register(EnemyVulnerabilityDefinition(
            enemyType: "нежить",
            modifiers: [
                VulnerabilityModifier(actionType: .strike, zone: .prav, modifier: 3),
                VulnerabilityModifier(actionType: .influence, zone: .nav, modifier: -2)
            ]
        ))

        return registry
    }
}
